<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title data-i18n="page_title_advanced_settings">Advanced Settings</title>
    <style>
        :root{--bg-deep-dark:#121821;--bg-dark:#1a222e;--bg-light:#2c3a4b;--accent-primary:#00bcd4;--accent-secondary:#0097a7;--text-light:#e0e7ff;--text-medium:#a0a8b4;--text-dark:#121821;--border-color:#3a4a5f;--success-color:#4caf50;--error-color:#d32f2f;--font-family:'Segoe UI',-apple-system,BlinkMacSystemFont,'Roboto',sans-serif}
        body{font-family:var(--font-family);margin:0;background-color:var(--bg-deep-dark);color:var(--text-light);padding:2rem}
        .container{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr;gap:2rem}
        .panel-box{background-color:var(--bg-dark);border:1px solid var(--border-color);border-radius:12px;padding:1.5rem}
        .panel-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);padding-bottom:1rem;margin-bottom:1.5rem}
        h1,h2{color:var(--accent-primary);margin:0}
        .settings-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(400px, 1fr));gap:2rem}
        .input-group{margin-bottom:1.5rem}
        .input-group label{display:block;font-size:.9rem;color:var(--text-medium);margin-bottom:.5rem}
        .input-group select, .input-group input[type="text"], .input-group input[type="password"]{width:100%;padding:.7rem;background-color:var(--bg-deep-dark);border:1px solid var(--border-color);border-radius:6px;color:var(--text-light);font-size:1rem}
        .toggle-switch{display:flex;align-items:center;gap:1rem;margin-top:1rem}
        .toggle-switch .label{font-size:1rem}
        .switch{position:relative;display:inline-block;width:60px;height:34px}.switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--bg-light);transition:.4s;border-radius:34px}.slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background-color:#fff;transition:.4s;border-radius:50%}input:checked+.slider{background-color:var(--accent-primary)}input:checked+.slider:before{transform:translateX(26px)}
        .button{padding:.75rem 1.5rem;border:none;border-radius:8px;font-weight:600;font-size:1rem;cursor:pointer;text-decoration:none}.button-primary{background-color:var(--accent-primary);color:var(--text-dark)}.button-secondary{background-color:var(--bg-light);color:var(--text-light)}
        .footer-actions{margin-top:2rem;display:flex;justify-content:flex-end;gap:1rem}
        #ui-lang-select { background-color:var(--bg-light); border:1px solid var(--border-color); color:var(--text-light); border-radius:6px; padding:0.25rem 0.5rem; font-size:0.8rem; }
        .ai-instructions { font-size: 0.9rem; color: var(--text-medium); line-height: 1.5; }
        .ai-instructions a { color: var(--accent-primary); text-decoration: none; }
        #log { 
            background: var(--bg-deep-dark);
            padding: 1rem;
            border-radius: 8px;
            min-height: 50px; 
            flex-grow: 1; 
            overflow-y: auto; 
            white-space: pre-wrap; 
            margin-top: 0.5rem;
        }
        .button-danger{background-color:var(--error-color);color:var(--text-light)}		
    </style>
</head>
<body>
    <div class="container">
        <div class="panel-box">
            <div class="panel-header">
                <h1 data-i18n="advanced_settings_title">Advanced Settings</h1>
                <div>
                     <select id="ui-lang-select" title="Select UI Language">
                        <option value="en">English (UI)</option>
                        <option value="de">German (UI)</option>
                        <option value="fr">Français (UI)</option>
                        <option value="es">Español (UI)</option>
                        <option value="it">Italiano (UI)</option>
                        <option value="sv">Svenska (UI)</option>
                    </select>
                </div>
            </div>

            <div class="panel-box" style="margin-bottom: 2rem; display: flex; align-items: flex-start; gap: 2rem;">
                <div style="flex: 1;">
                    <h2 data-i18n="ai_settings_title">AI Name Guesser (Gemini)</h2>
                    <p class="ai-instructions" data-i18n="ai_instructions_text">To enable the AI name guesser, you need a free API key from Google AI Studio. No credit card is required. Get one here: https://aistudio.google.com/app/apikey</p>
                    <div class="input-group">
                        <label for="google-api-key" data-i18n="api_key_label">Google AI API Key</label>
                        <input type="password" id="google-api-key" data-i18n-title="api_key_tooltip">
                    </div>
                    <button onclick="testApiKey()" class="button button-secondary" style="width: auto;" data-i18n="test_key_button" data-i18n-title="test_key_button_tooltip">Test Key</button>
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; min-height: 180px;">
                    <label data-i18n="log_title" style="font-size: .9rem; color: var(--text-medium); margin-bottom: 0;">Live Log</label>
                    <pre id="log"></pre>
                </div>
            </div>
            <div class="settings-grid">
                <div class="panel-box">
                    <h2 data-i18n="media_source_title">Media Sources</h2>
                    <div class="input-group">
                        <label for="source-for-image" data-i18n="source_for_image_label">'Image' Column Source</label>
                        <select id="source-for-image" data-i18n-title="source_for_image_tooltip">
                            <option value="ss">Screenshot</option>
                            <option value="box-2D">Boxart 2D</option>
                            <option value="box-3D">Boxart 3D</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="source-for-box" data-i18n="source_for_box_label">'Box' Column Source</label>
                        <select id="source-for-box" data-i18n-title="source_for_box_tooltip">
                            <option value="box-2D">Boxart 2D</option>
                            <option value="box-3D">Boxart 3D</option>
                            <option value="ss">Screenshot</option>
                        </select>
                    </div>
                </div>

                <div class="panel-box">
                    <h2 data-i18n="media_selection_title">Media Selection Strategy</h2>
                     <div class="input-group">
                        <label for="strategy-for-image" data-i18n="strategy_for_image_label">For 'Image'</label>
                        <select id="strategy-for-image" data-i18n-title="strategy_for_image_tooltip"></select>
                    </div>
                    <div class="input-group">
                        <label for="strategy-for-video" data-i18n="strategy_for_video_label">For 'Video'</label>
                        <select id="strategy-for-video" data-i18n-title="strategy_for_video_tooltip"></select>
                    </div>
                    <div class="input-group">
                        <label for="strategy-for-marquee" data-i18n="strategy_for_marquee_label">For 'Logo'</label>
                        <select id="strategy-for-marquee" data-i18n-title="strategy_for_marquee_tooltip"></select>
                    </div>
                    <div class="input-group">
                        <label for="strategy-for-thumbnail" data-i18n="strategy_for_thumbnail_label">For 'Box'</label>
                        <select id="strategy-for-thumbnail" data-i18n-title="strategy_for_thumbnail_tooltip"></select>
                    </div>
                </div>
            </div>

            <div class="panel-box" style="margin-top: 2rem;">
                 <h2 data-i18n="directory_settings_title">Directory Settings</h2>
                 <div class="toggle-switch" data-i18n-title="save_in_rom_dir_tooltip">
                     <span class="label" data-i18n="save_in_rom_dir_label">Save media in ROM directory</span>
                     <label class="switch">
                         <input type="checkbox" id="save-media-in-rom-dir">
                         <span class="slider"></span>
                     </label>
                 </div>
                 <div class="input-group" style="margin-top: 1.5rem;">
                     <label for="name-media-dir" data-i18n="media_dir_name_label">Media sub-folder name</label>
                     <input type="text" id="name-media-dir" data-i18n-title="media_dir_name_tooltip">
                 </div>
            </div>
            
        <div class="footer-actions">
                <button onclick="resetSettings()" class="button button-danger" data-i18n="reset_to_default_button" data-i18n-title="reset_to_default_tooltip">Reset to Defaults</button>
                <div style="flex-grow: 1;"></div> <a href="index.html" class="button button-secondary" data-i18n="cancel_button" data-i18n-title="cancel_button_tooltip">Cancel</a>
                <button onclick="saveAdvancedSettings()" class="button button-primary" data-i18n="save_changes_button" data-i18n-title="save_changes_button_tooltip">Confirm and Save</button>
            </div>
        </div>
    </div>
<script>
    let i18nData = {};
    const logEl = document.getElementById('log');

    const elements = {
        google_api_key: document.getElementById('google-api-key'),
        source_for_image: document.getElementById('source-for-image'),
        source_for_box: document.getElementById('source-for-box'),
        strategy_for_image: document.getElementById('strategy-for-image'),
        strategy_for_video: document.getElementById('strategy-for-video'),
        strategy_for_marquee: document.getElementById('strategy-for-marquee'),
        strategy_for_thumbnail: document.getElementById('strategy-for-thumbnail'),
        save_media_in_rom_dir: document.getElementById('save-media-in-rom-dir'),
        name_media_dir: document.getElementById('name-media-dir'),
        uiLangSelect: document.getElementById('ui-lang-select')
    };
    
    const strategyOptions = [
        { value: 'best_resolution', i18n_key: 'strategy_best_resolution' },
        { value: 'first', i18n_key: 'strategy_first' },
        { value: 'last', i18n_key: 'strategy_last' },
        { value: 'largest_size', i18n_key: 'strategy_largest_size' },
        { value: 'smallest_size', i18n_key: 'strategy_smallest_size' }
    ];

    function populateStrategySelects() {
        const selects = [elements.strategy_for_image, elements.strategy_for_video, elements.strategy_for_marquee, elements.strategy_for_thumbnail];
        selects.forEach(select => {
            select.innerHTML = '';
            strategyOptions.forEach(opt => {
                const optionText = i18nData[opt.i18n_key] || opt.value.replace(/_/g, ' ');
                select.add(new Option(optionText, opt.value));
            });
        });
    }

    async function fetchLanguage(lang) {
        try {
            const response = await fetch(`/lang/${lang}.json?v=${new Date().getTime()}`);
            if (!response.ok) throw new Error(`Language file for '${lang}' not found.`);
            i18nData = await response.json();
            localStorage.setItem('preferred_language', lang);
            document.documentElement.lang = lang;
            elements.uiLangSelect.value = lang;
            applyTranslations();
        } catch (error) {
            console.error(error.message);
            if (lang !== 'en') { await fetchLanguage('en'); }
        }
    }

    function applyTranslations() {
        document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.dataset.i18n; if (i18nData[key]) el.textContent = i18nData[key]; });
        document.querySelectorAll('[data-i18n-title]').forEach(el => { const key = el.dataset.i18nTitle; if (i18nData[key]) el.title = i18nData[key]; });
        populateStrategySelects();
        loadSettings();
    }
    
    async function loadSettings() {
        try {
            const response = await fetch('/get-settings');
            const settings = await response.json();
            elements.google_api_key.value = settings.api_key || '';
            elements.source_for_image.value = settings.source_for_image || 'ss';
            elements.source_for_box.value = settings.source_for_box || 'box-2D';
            elements.strategy_for_image.value = settings.strategy_for_image || 'best_resolution';
            elements.strategy_for_video.value = settings.strategy_for_video || 'best_resolution';
            elements.strategy_for_marquee.value = settings.strategy_for_marquee || 'best_resolution';
            elements.strategy_for_thumbnail.value = settings.strategy_for_thumbnail || 'best_resolution';
            elements.save_media_in_rom_dir.checked = settings.save_media_in_rom_dir === true;
            elements.name_media_dir.value = settings.name_media_dir || 'downloaded_images';
        } catch (error) {
            logEl.textContent = `Error loading settings: ${error.message}`;
        }
    }

    async function saveAdvancedSettings() {
        logEl.textContent = i18nData.log_saving || 'Saving settings...';
        const settingsToSave = {
            api_key: elements.google_api_key.value,
            source_for_image: elements.source_for_image.value,
            source_for_box: elements.source_for_box.value,
            strategy_for_image: elements.strategy_for_image.value,
            strategy_for_video: elements.strategy_for_video.value,
            strategy_for_marquee: elements.strategy_for_marquee.value,
            strategy_for_thumbnail: elements.strategy_for_thumbnail.value,
            save_media_in_rom_dir: elements.save_media_in_rom_dir.checked,
            name_media_dir: elements.name_media_dir.value
        };

        try {
            const response = await fetch('/save-settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settingsToSave)
            });
            if (!response.ok) throw new Error('Server returned an error.');
            logEl.textContent = i18nData.log_save_success || 'Settings saved successfully!';
            setTimeout(() => { window.location.href = 'index.html'; }, 1500);
        } catch (error) {
            logEl.textContent = `${i18nData.log_save_fail || 'Failed to save settings:'} ${error.message}`;
        }
    }

    async function testApiKey() {
        const key = elements.google_api_key.value;
        if (!key) {
            logEl.textContent = i18nData.log_key_missing || 'Please enter an API key to test.';
            return;
        }
        logEl.textContent = i18nData.log_key_testing || 'Testing API key...';
        try {
            const response = await fetch('/test-api-key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ api_key: key })
            });
            const result = await response.json();
            if (response.ok && result.success) {
                logEl.textContent = i18nData.log_key_success || 'API Key is valid!';
            } else {
                logEl.textContent = `${i18nData.log_key_fail || 'API Key is invalid:'} ${result.error || 'Unknown error'}`;
            }
        } catch (error) {
            logEl.textContent = `${i18nData.log_key_fail || 'API Key is invalid:'} ${error.message}`;
        }
    }

    async function resetSettings() {
        const confirmReset = confirm(i18nData.reset_confirm_prompt || "Are you sure you want to reset all advanced settings to their default values? This cannot be undone.");
        if (!confirmReset) return;

        logEl.textContent = i18nData.log_resetting || 'Resetting settings to default...';
        try {
            const response = await fetch('/reset-settings-to-default', {
                method: 'POST'
            });
            if (!response.ok) throw new Error('Server returned an error.');
            logEl.textContent = i18nData.log_reset_success || 'Settings have been reset. Reloading...';
            setTimeout(() => { window.location.reload(); }, 1500);
        } catch (error) {
            logEl.textContent = `${i18nData.log_reset_fail || 'Failed to reset settings:'} ${error.message}`;
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const preferredLang = localStorage.getItem('preferred_language') || 'en';
        await fetchLanguage(preferredLang);
        elements.uiLangSelect.addEventListener('change', e => fetchLanguage(e.target.value));
    });
</script>
</body>
</html>